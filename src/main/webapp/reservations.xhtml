<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:h="jakarta.faces.html" xmlns:f="jakarta.faces.core"
    xmlns:ui="jakarta.faces.facelets">
<ui:composition template="template.xhtml">
    <ui:define name="title">RÃ©servations - Agence Transport</ui:define>

    <ui:define name="content">
        <div class="card mb-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>ðŸ“‹ Gestion des RÃ©servations</h2>
                <button type="button" class="btn btn-primary rounded-pill" data-bs-toggle="modal"
                    data-bs-target="#newReservationModal">
                    + Nouvelle RÃ©servation
                </button>
            </div>

            <div class="table-container">
                <h:dataTable value="#{reservationBean.reservations}" var="res" styleClass="w-100">
                    <h:column>
                        <f:facet name="header">ID</f:facet>
                        #{res.id}
                    </h:column>
                    <h:column>
                        <f:facet name="header">Passager</f:facet>
                        <div class="fw-bold">#{res.passengerName}</div>
                        <small class="text-muted">#{res.passengerEmail}</small>
                    </h:column>
                    <h:column>
                        <f:facet name="header">Trajet</f:facet>
                        #{res.departureLocation} â†’ #{res.destinationLocation}
                    </h:column>
                    <h:column>
                        <f:facet name="header">Date</f:facet>
                        #{res.departureDate}
                    </h:column>
                    <h:column>
                        <f:facet name="header">Places</f:facet>
                        #{res.numberOfSeats}
                    </h:column>
                    <h:column>
                        <f:facet name="header">Statut</f:facet>
                        <span class="badge #{res.status == 'PENDING' ? 'badge-warning' : 
                                          res.status == 'CONFIRMED' ? 'badge-success' : 
                                          res.status == 'CANCELLED' ? 'badge-danger' : 'badge-info'}">
                            #{res.status}
                        </span>
                    </h:column>
                    <h:column>
                        <f:facet name="header">Actions</f:facet>
                        <h:form styleClass="d-inline">
                            <h:commandLink action="#{reservationBean.prepareConfirm(res)}"
                                styleClass="btn btn-sm btn-outline-success me-1" rendered="#{res.status == 'PENDING'}">
                                <f:ajax render="confirmForm"
                                    onevent="function(data){ if(data.status === 'success') new bootstrap.Modal(document.getElementById('confirmModal')).show(); }" />
                                Confirmer
                            </h:commandLink>
                            <h:commandLink action="#{reservationBean.cancelReservation(res.id)}"
                                styleClass="btn btn-sm btn-outline-danger" rendered="#{res.status == 'PENDING'}">
                                Annuler
                            </h:commandLink>
                        </h:form>
                    </h:column>
                </h:dataTable>
            </div>
        </div>

        <!-- Modal for Confirmation with Resources -->
        <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <h:form id="confirmForm">
                        <div class="modal-header">
                            <h:panelGroup layout="block" styleClass="modal-title h5">Confirmer la RÃ©servation
                                ##{reservationBean.selectedReservation.id}</h:panelGroup>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info">
                                Affectez un bus et un chauffeur pour valider cette rÃ©servation.
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Bus (Service 1)</label>
                                <h:selectOneMenu value="#{reservationBean.busIdForConfirmation}"
                                    styleClass="form-select" required="true">
                                    <f:selectItem itemLabel="-- SÃ©lectionner un bus --" itemValue="" />
                                    <f:selectItems value="#{reservationBean.availableBuses}" var="b"
                                        itemLabel="#{b.label}" itemValue="#{b.id}" />
                                </h:selectOneMenu>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Chauffeur (Service 2)</label>
                                <h:selectOneMenu value="#{reservationBean.chauffeurIdForConfirmation}"
                                    styleClass="form-select" required="true">
                                    <f:selectItem itemLabel="-- SÃ©lectionner un chauffeur --" itemValue="" />
                                    <f:selectItems value="#{reservationBean.availableChauffeurs}" var="c"
                                        itemLabel="#{c.label}" itemValue="#{c.id}" />
                                </h:selectOneMenu>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                            <h:commandButton value="Valider la Confirmation"
                                action="#{reservationBean.confirmReservation}" styleClass="btn btn-success" />
                        </div>
                    </h:form>
                </div>
            </div>
        </div>

        <!-- Modal for New Reservation -->
        <div class="modal fade" id="newReservationModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <h:form id="reservationForm">
                        <div class="modal-header">
                            <h:panelGroup layout="block" styleClass="modal-title h5">Nouvelle RÃ©servation</h:panelGroup>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Nom du passager</label>
                                <h:inputText value="#{reservationBean.passengerName}" styleClass="form-control"
                                    required="true" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <h:inputText value="#{reservationBean.passengerEmail}" styleClass="form-control"
                                    required="true" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">DÃ©part</label>
                                <h:inputText value="#{reservationBean.departureLocation}" styleClass="form-control"
                                    required="true" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Destination</label>
                                <h:inputText value="#{reservationBean.destinationLocation}" styleClass="form-control"
                                    required="true" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Date et Heure de dÃ©part</label>
                                <h:inputText value="#{reservationBean.departureDate}" styleClass="form-control"
                                    type="datetime-local" required="true">
                                    <f:convertDateTime type="localDateTime" pattern="yyyy-MM-dd'T'HH:mm" />
                                </h:inputText>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Nombre de places</label>
                                <h:inputText value="#{reservationBean.numberOfSeats}" styleClass="form-control"
                                    required="true" />
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                            <h:commandButton value="Enregistrer" action="#{reservationBean.createReservation}"
                                styleClass="btn btn-primary" />
                        </div>
                    </h:form>
                </div>
            </div>
        </div>
    </ui:define>
</ui:composition>

</html>